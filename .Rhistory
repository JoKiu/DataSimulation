########################################
## Parameter
########################################
n <- 3000
n_train <- n / 2
n_calib <- n / 2
n_test <- 3000
beta <- 20 / sqrt(n)
xmin <- 0; xmax <- 4
exp_rate <- 0.4
alpha <- 0.1
########################################
## Data generating models
########################################
gen_t <- function(x) exp(2 + beta * sqrt(abs(x)) +  1.5 * rnorm(length(x)))
gen_c <- function(x) rexp(rate = exp_rate, n = length(x))
########################################
## Generate training data
########################################
set.seed(24601)
X <- runif(n_train, xmin, xmax)
T <- gen_t(X)
C <- gen_c(X)
event <- (T < C)
censored_T <- pmin(T, C)
data_fit <- data.frame(X1 = X, C = C, censored_T = censored_T, event = event)
########################################
## Generate the calibration data and the test data
########################################
set.seed(seed)
X <- runif(n_calib + n_test, xmin, xmax)
T <- gen_t(X)
C <- gen_c(X)
event <- (T < C)
censored_T <- pmin(T, C)
data <- data.frame(X1 = X, C = C, event = event, censored_T = censored_T)
data_calib <- data[1 : n_calib, ]
data_test <- data[(n_calib + 1) : (n_calib + n_test), ]
data <- rbind(data_fit, data_calib)
surv.obj<- Surv(time = data$censored_T,event = data$event,type = 'left')
#plot(surv.obj)
summary(surv.obj)
fit1<-survfit(Surv(data$censored_T,data$event)~1)
delta <- diff(fit1$time,tao)
tao = 15 #set maximum followup time
delta <- diff(fit1$time,tao)
delta
fit1[1,]
delta_t <- diff(fit1$time,tao)
length(fit1$time)
tau = 15 #set maximum followup time
delta_t <- diff(fit1$time,tau)
n_t <- length(delta_t)
0:n_t
delta_surv <- diff(fit1$surv[1:n_t])
length(delta_surv)
delta_surv <- diff(fit1$surv[1:n_t+1])
delta_surv <- diff(fit1$surv[1:(n_t+1)])
delta_surv <- rowMeans(fit1$surv[1:(n_t+1)])
delta_surv <- rowMeans(fit1$surv])
delta_surv <- rowMeans(fit1$surv)
rowMeans(fit1$surv)
fit1$surv
delta_surv <- rowMeans(as.data.frame(fit1$surv))
rowMeans(as.data.frame(fit1$surv))
delta_surv <- rowMeans(as.data.frame(fit1$surv))[,1]
delta_surv <- rowMeans(as.data.frame(fit1$surv))[1:n_t]
delta_t*delta_surv
sum(delta_t*delta_surv)
rep(NA,1:10)
rep(NA,10)
c(1:10)[-5]
c(2:10)[-5]
get.po.df<-function(censored_T,event,tau=15){
stopifnot(length(censored_T)==length(event))
n<-length(censored_T)
fit1<-survfit(Surv(censored_T,event)~1)
tau = 15 #set maximum followup time
delta_t <- diff(fit1$time,tau)
n_t <- length(delta_t)
delta_surv <- rowMeans(as.data.frame(fit1$surv))[1:n_t]
output<-rep(NA,n)
for(i in 1:n){
fit2<-survfit(Surv(data$censored_T[-i],data$event[-i])~1)
delta_ti <- diff(fit2$time,tau)
n_ti <- length(delta_ti)
delta_surv_i <- rowMeans(as.data.frame(fit2$surv))[1:n_ti]
output[i]<-n*sum(delta_surv*delta_t)-(n-1)*sum(delta_surv_i*delta_ti)
}
return(output)
}
survfit(Surv(data$censored_T,data$event)~1)
get.po<-function(censored_T,event,tau=15){
stopifnot(length(censored_T)==length(event))
n<-length(censored_T)
fit1<-survfit(Surv(censored_T,event)~1)
tau = 15 #set maximum followup time
delta_t <- diff(fit1$time,tau)
n_t <- length(delta_t)
delta_surv <- rowMeans(as.data.frame(fit1$surv))[1:n_t]
output<-rep(NA,n)
for(i in 1:n){
fit2<-survfit(Surv(data$censored_T[-i],data$event[-i])~1)
delta_ti <- diff(fit2$time,tau)
n_ti <- length(delta_ti)
delta_surv_i <- rowMeans(as.data.frame(fit2$surv))[1:n_ti]
output[i]<-n*sum(delta_surv*delta_t)-(n-1)*sum(delta_surv_i*delta_ti)
}
return(output)
}
get.po(data$censored_T,data$event)
diff(fit1$time,tau)
diff(fit1$time,tau)%>%plot
diff(fit1$time,tau)%>%plot()
library(magrittr)
diff(fit1$time,tau)%>%plot()
get.po(data$censored_T,data$event,tau = 10)
get.po<-function(censored_T,event,tau=15){
stopifnot(length(censored_T)==length(event))
n<-length(censored_T)
fit1<-survfit(Surv(censored_T,event)~1)
tau = 15 #set maximum followup time
delta_t <- diff(fit1$time,tau)
n_t <- length(delta_t)
delta_surv <- rowMeans(as.data.frame(fit1$surv))[1:n_t]
output<-rep(NA,n)
for(i in 1:n){
fit2<-survfit(Surv(censored_T[-i],event[-i])~1)
delta_ti <- diff(fit2$time,tau)
n_ti <- length(delta_ti)
delta_surv_i <- rowMeans(as.data.frame(fit2$surv))[1:n_ti]
output[i]<-n*sum(delta_surv*delta_t)-(n-1)*sum(delta_surv_i*delta_ti)
}
return(output)
}
get.po(data$censored_T,data$event,tau = 10)
sum(delta_surv*delta_t)
test<-rep(NA,nrow(data))
test.i<-1
fit2<-survfit(Surv(censored_T[test.i],event[-test.i])~1)
fit2<-survfit(Surv(data$censored_T[test.i],data$event[-test.i])~1)
test.i<-1
fit2<-survfit(Surv(data$censored_T[test.i],data$event[-test.i])~1)
fit2<-survfit(Surv(data$censored_T[-test.i],data$event[-test.i])~1)
delta_ti <- diff(fit2$time,tau)
delta_ti
n_ti <- length(delta_ti)
delta_surv_i <- rowMeans(as.data.frame(fit2$surv))[1:n_ti]
output[i]<-n*sum(delta_surv*delta_t)-(n-1)*sum(delta_surv_i*delta_ti)
test.output<-n*sum(delta_surv*delta_t)-(n-1)*sum(delta_surv_i*delta_ti)
test.output
(n-1)*sum(delta_surv_i*delta_ti)
sum(delta_surv*delta_t)-sum(delta_surv_i*delta_ti)
n*sum(delta_surv*delta_t)-(n-1)*sum(delta_surv_i*delta_ti)
sum(1:10)
delta_surv*delta_t
rowMeans(as.data.frame(1:10))
rowMeans(as.data.frame(v1=1:10))
rowMeans(as.data.frame(v1=c(1:10)))
as.data.frame(v1=c(1:10))
data.frame(v1=c(1:10))
rowMeans(data.frame(v1=1:10))
rowMeans(data.frame(v1=c(1:10)))
sapply(list(fit2$surv[1:n_ti],fit2$surv[2:(n_ti+1)])
sapply(list(fit2$surv[1:n_ti],fit2$surv[2:(n_ti+1)]))
sapply(list(fit2$surv[1:n_ti],fit2$surv[2:(n_ti+1)]),mean)
cbind(fit2$surv[1:n_ti],fit2$surv[2:(n_ti+1)])
cbind(fit2$surv[1:n_ti],fit2$surv[2:(n_ti+1)])%>%rowMeans()
rowMeans(cbind(fit1$surv[1:(n_t-1)],fit1$surv[2:(n_t)]))
get.po<-function(censored_T,event,tau=15){
stopifnot(length(censored_T)==length(event))
n<-length(censored_T)
fit1<-survfit(Surv(censored_T,event)~1)
tau = 15 #set maximum followup time
delta_t <- diff(fit1$time,tau)
n_t <- length(delta_t)
delta_surv <- rowMeans(cbind(fit1$surv[1:(n_t-1)],fit1$surv[2:(n_t)]))
output<-rep(NA,n)
for(i in 1:n){
fit2<-survfit(Surv(censored_T[-i],event[-i])~1)
delta_ti <- diff(fit2$time,tau)
n_ti <- length(delta_ti)
delta_surv_i <- rowMeans(cbind(fit2$surv[1:(n_ti-1)],fit2$surv[2:(n_ti)]))
output[i]<-n*sum(delta_surv*delta_t)-(n-1)*sum(delta_surv_i*delta_ti)
}
return(output)
}
get.po(data$censored_T,data$event)
test.i<-1
fit2<-survfit(Surv(data$censored_T[-test.i],data$event[-test.i])~1)
test.i<-1
fit2<-survfit(Surv(data$censored_T[-test.i],data$event[-test.i])~1)
delta_ti <- diff(fit2$time,tau)
n_ti <- length(delta_ti)
delta_surv_i <- rowMeans(cbind(fit2$surv[1:(n_ti-1)],fit2$surv[2:(n_ti)]))
test.output<-n*sum(delta_surv*delta_t)-(n-1)*sum(delta_surv_i*delta_
ti)
test.i<-1
fit2<-survfit(Surv(data$censored_T[-test.i],data$event[-test.i])~1)
delta_ti <- diff(fit2$time,tau)
n_ti <- length(delta_ti)
delta_surv_i <- rowMeans(cbind(fit2$surv[1:(n_ti-1)],fit2$surv[2:(n_ti)]))
test.output<-n*sum(delta_surv*delta_t)-(n-1)*sum(delta_surv_i*delta_ti)
n*sum(delta_surv*delta_t)
(n-1)*sum(delta_surv_i*delta_ti)
delta_surv_i
fit1$time
diff(1:10,15)
diff(c(1:10),15)
diff(c(1:20),15)
diff(1,2,3)
diff(c(1,2,3))
fit1$time
diff(fit1$time)
time_0 <- fit1$time[which(fit1$time<=tau)]
delta_t <- diff(time_0)
n_t <- length(time_0)
delta_surv <- rowMeans(cbind(time_0[1:(n_t-1)],time_0[2:(n_t)]))
output<-rep(NA,n)
fit2<-survfit(Surv(censored_T[-i],event[-i])~1)
delta_surv <- rowMeans(cbind(time_0[1:(n_t-1)],time_0[2:(n_t)]))
delta_surv
delta_t
get.po<-function(censored_T,event,tau=15){
stopifnot(length(censored_T)==length(event))
n<-length(censored_T)
fit1<-survfit(Surv(censored_T,event)~1)
tau = 15 #set maximum followup time
time_0 <- fit1$time[which(fit1$time<=tau)]
delta_t <- diff(time_0)
n_t <- length(time_0)
delta_surv <- rowMeans(cbind(fit1$surv[1:(n_t-1)],fit1$surv[2:n_t]))
output<-rep(NA,n)
for(i in 1:n){
fit2<-survfit(Surv(censored_T[-i],event[-i])~1)
time_1 <- fit1$time[which(fit1$time<=tau)]
delta_ti <- diff(time_1)
n_ti <- length(delta_ti)
delta_surv_i <- rowMeans(cbind(fit2$surv[1:(n_ti-1)],fit2$surv[2:n_ti]))
output[i]<-n*sum(delta_surv*delta_t)-(n-1)*sum(delta_surv_i*delta_ti)
}
return(output)
}
get.po(data$censored_T,data$event)
warning9
warning()
get.po(data$censored_T,data$event)
warning()
warnings()
get.po(data$censored_T,data$event)
get.po(data$censored_T,data$event)
get.po<-function(censored_T,event,tau=15){
stopifnot(length(censored_T)==length(event))
n<-length(censored_T)
fit1<-survfit(Surv(censored_T,event)~1)
tau = 15 #set maximum followup time
time_0 <- fit1$time[which(fit1$time<=tau)]
delta_t <- diff(time_0)
n_t <- length(time_0)
delta_surv <- rowMeans(cbind(fit1$surv[1:(n_t-1)],fit1$surv[2:n_t]))
output<-rep(NA,n)
for(i in 1:n){
fit2<-survfit(Surv(censored_T[-i],event[-i])~1)
time_1 <- fit1$time[which(fit1$time<=tau)]
delta_ti <- diff(time_1)
n_ti <- length(delta_ti)
delta_surv_i <- rowMeans(cbind(fit2$surv[1:(n_ti-1)],fit2$surv[2:n_ti]))
output[i]<-n*sum(delta_surv*delta_t)-(n-1)*sum(delta_surv_i*delta_ti)
}
return(output)
}
get.po(data$censored_T,data$event)
get.po<-function(censored_T,event,tau=15){
stopifnot(length(censored_T)==length(event))
n<-length(censored_T)
fit1<-survfit(Surv(censored_T,event)~1)
tau = 15 #set maximum followup time
time_0 <- fit1$time[which(fit1$time<=tau)]
delta_t <- diff(time_0)
n_t <- length(time_0)
delta_surv <- rowMeans(cbind(fit1$surv[1:(n_t-1)],fit1$surv[2:n_t]))
browser()
output<-rep(NA,n)
for(i in 1:n){
fit2<-survfit(Surv(censored_T[-i],event[-i])~1)
time_1 <- fit1$time[which(fit1$time<=tau)]
delta_ti <- diff(time_1)
n_ti <- length(delta_ti)
delta_surv_i <- rowMeans(cbind(fit2$surv[1:(n_ti-1)],fit2$surv[2:n_ti]))
output[i]<-n*sum(delta_surv*delta_t)-(n-1)*sum(delta_surv_i*delta_ti)
}
return(output)
}
get.po(data$censored_T,data$event)
delta_surv
delta_t
delta_t%>%length()
delta_surv%>%length()
get.po<-function(censored_T,event,tau=15){
stopifnot(length(censored_T)==length(event))
n<-length(censored_T)
fit1<-survfit(Surv(censored_T,event)~1)
tau = 15 #set maximum followup time
time_0 <- fit1$time[which(fit1$time<=tau)]
delta_t <- diff(time_0)
n_t <- length(time_0)
delta_surv <- rowMeans(cbind(fit1$surv[1:(n_t-1)],fit1$surv[2:n_t]))
browser()
output<-rep(NA,n)
for(i in 1:n){
fit2<-survfit(Surv(censored_T[-i],event[-i])~1)
time_1 <- fit2$time[which(fit2$time<=tau)]
delta_ti <- diff(time_1)
n_ti <- length(delta_ti)
delta_surv_i <- rowMeans(cbind(fit2$surv[1:(n_ti-1)],fit2$surv[2:n_ti]))
browser()
output[i]<-n*sum(delta_surv*delta_t)-(n-1)*sum(delta_surv_i*delta_ti)
}
return(output)
}
get.po(data$censored_T,data$event)
delta_surv_i
delta_surv_i%>%length()
sum(delta_surv*delta_t)-sum(delta_surv_i*delta_ti)
n_ti
n_t
length(delta_t)
length(delta_surv)
length(delta_surv_i)
length(delta_ti)
n_ti
get.po<-function(censored_T,event,tau=15){
stopifnot(length(censored_T)==length(event))
n<-length(censored_T)
fit1<-survfit(Surv(censored_T,event)~1)
tau = 15 #set maximum followup time
time_0 <- fit1$time[which(fit1$time<=tau)]
delta_t <- diff(time_0)
n_t <- length(time_0)
delta_surv <- rowMeans(cbind(fit1$surv[1:(n_t-1)],fit1$surv[2:n_t]))
browser()
output<-rep(NA,n)
for(i in 1:n){
fit2<-survfit(Surv(censored_T[-i],event[-i])~1)
time_1 <- fit2$time[which(fit2$time<=tau)]
delta_ti <- diff(time_1)
n_ti <- length(time_1)
delta_surv_i <- rowMeans(cbind(fit2$surv[1:(n_ti-1)],fit2$surv[2:n_ti]))
browser()
output[i]<-n*sum(delta_surv*delta_t)-(n-1)*sum(delta_surv_i*delta_ti)
}
return(output)
}
get.po(data$censored_T,data$event)
get.po<-function(censored_T,event,tau=15){
stopifnot(length(censored_T)==length(event))
n<-length(censored_T)
fit1<-survfit(Surv(censored_T,event)~1)
tau = 15 #set maximum followup time
time_0 <- fit1$time[which(fit1$time<=tau)]
delta_t <- diff(time_0)
n_t <- length(time_0)
delta_surv <- rowMeans(cbind(fit1$surv[1:(n_t-1)],fit1$surv[2:n_t]))
browser()
output<-rep(NA,n)
for(i in 1:n){
fit2<-survfit(Surv(censored_T[-i],event[-i])~1)
time_1 <- fit2$time[which(fit2$time<=tau)]
delta_ti <- diff(time_1)
n_ti <- length(time_1)
delta_surv_i <- rowMeans(cbind(fit2$surv[1:(n_ti-1)],fit2$surv[2:n_ti]))
browser()
output[i]<-n*sum(delta_surv*delta_t)-(n-1)*sum(delta_surv_i*delta_ti)
}
return(output)
}
get.po(data$censored_T,data$event)
n*sum(delta_surv*delta_t)-(n-1)*sum(delta_surv_i*delta_ti)
get.po<-function(censored_T,event,tau=15){
stopifnot(length(censored_T)==length(event))
n<-length(censored_T)
fit1<-survfit(Surv(censored_T,event)~1)
tau = 15 #set maximum followup time
time_0 <- fit1$time[which(fit1$time<=tau)]
delta_t <- diff(time_0)
n_t <- length(time_0)
delta_surv <- rowMeans(cbind(fit1$surv[1:(n_t-1)],fit1$surv[2:n_t]))
output<-rep(NA,n)
for(i in 1:n){
fit2<-survfit(Surv(censored_T[-i],event[-i])~1)
time_1 <- fit2$time[which(fit2$time<=tau)]
delta_ti <- diff(time_1)
n_ti <- length(time_1)
delta_surv_i <- rowMeans(cbind(fit2$surv[1:(n_ti-1)],fit2$surv[2:n_ti]))
output[i]<-n*sum(delta_surv*delta_t)-(n-1)*sum(delta_surv_i*delta_ti)
}
return(output)
}
get.po(data$censored_T,data$event)
#########################################
## constructing pseudo observation survival time function
########################################
get.po<-function(censored_T,event,tau=15){
stopifnot(length(censored_T)==length(event))#check if length match
n<-length(censored_T)
fit1<-survfit(Surv(censored_T,event)~1)#fit the whole dataset survival fit
tau = 15 #set maximum followup time
time_0 <- fit1$time[which(fit1$time<=tau)]#subset the time below tau
delta_t <- diff(time_0) #calculating delta t
n_t <- length(time_0)
delta_surv <- rowMeans(cbind(fit1$surv[1:(n_t-1)],fit1$surv[2:n_t]))#calculate delta S(u)
output<-rep(NA,n)
for(i in 1:n){
fit2<-survfit(Surv(censored_T[-i],event[-i])~1) #removing one observation i
time_1 <- fit2$time[which(fit2$time<=tau)] #refit
delta_ti <- diff(time_1) #calculate time gap
n_ti <- length(time_1)
delta_surv_i <- rowMeans(cbind(fit2$surv[1:(n_ti-1)],fit2$surv[2:n_ti]))#calculate delta Si(u)
output[i]<-n*sum(delta_surv*delta_t)-(n-1)*sum(delta_surv_i*delta_ti)
}
return(output)
}
get.po(data$censored_T,data$event)
test.po<-get.po(data$censored_T,data$event)
test.po
hist(test.po)
hist(test.po,xlim = c(0,30))
hist(test.po,xlim = c(0,30),breaks = 30)
hist(test.po,xlim = c(0,30),breaks = 1000)
test.po.df<-data.frame(po=test.po,ct<- data$censored_T)
View(test.po.df)
delta_t>0
delta_t>0%>%table
delta_t>0%>%table()
(delta_t>0)%>%table()
(delta_surv>0)%>%table()
data$censored_T[-10]
data$censored_T[-10]%>%length()
delta_surv
fit1$surv
cbind(fit1$surv[1:(n_t-1)],fit1$surv[2:n_t])
rowMeans(cbind(fit1$surv[1:(n_t-1)],fit1$surv[2:n_t]))
delta_surv
#########################################
## constructing pseudo observation survival time function
########################################
get.po<-function(censored_T,event,tau=15){
stopifnot(length(censored_T)==length(event))#check if length match
n<-length(censored_T)
fit1<-survfit(Surv(censored_T,event)~1)#fit the whole dataset survival fit
tau = 15 #set maximum followup time
time_0 <- fit1$time[which(fit1$time<=tau)]#subset the time below tau
delta_t <- diff(time_0) #calculating delta t
n_t <- length(time_0)
delta_surv <- rowMeans(cbind(fit1$surv[1:(n_t-1)],fit1$surv[2:n_t]))#calculate delta S(u)
browser()
output<-rep(NA,n)
for(i in 1:n){
fit2<-survfit(Surv(censored_T[-i],event[-i])~1) #removing one observation i
time_1 <- fit2$time[which(fit2$time<=tau)] #refit
delta_ti <- diff(time_1) #calculate time gap
n_ti <- length(time_1)
delta_surv_i <- rowMeans(cbind(fit2$surv[1:(n_ti-1)],fit2$surv[2:n_ti]))#calculate delta Si(u)
output[i]<-n*sum(delta_surv*delta_t)-(n-1)*sum(delta_surv_i*delta_ti)
}
return(output)
}
#########################################
## constructing pseudo observation survival time function
########################################
get.po<-function(censored_T,event,tau=15){
stopifnot(length(censored_T)==length(event))#check if length match
n<-length(censored_T)
fit1<-survfit(Surv(censored_T,event)~1)#fit the whole dataset survival fit
tau = 15 #set maximum followup time
time_0 <- fit1$time[which(fit1$time<=tau)]#subset the time below tau
delta_t <- diff(time_0) #calculating delta t
n_t <- length(time_0)
delta_surv <- rowMeans(cbind(fit1$surv[1:(n_t-1)],fit1$surv[2:n_t]))#calculate delta S(u)
browser()
output<-rep(NA,n)
for(i in 1:n){
fit2<-survfit(Surv(censored_T[-i],event[-i])~1) #removing one observation i
time_1 <- fit2$time[which(fit2$time<=tau)] #refit
delta_ti <- diff(time_1) #calculate time gap
n_ti <- length(time_1)
delta_surv_i <- rowMeans(cbind(fit2$surv[1:(n_ti-1)],fit2$surv[2:n_ti]))#calculate delta Si(u)
browser()
output[i]<-n*sum(delta_surv*delta_t)-(n-1)*sum(delta_surv_i*delta_ti)
}
return(output)
}
test.po<-get.po(data$censored_T,data$event)
delta_surv
sum(delta_surv*delta_t)
delta_surv_i
sum(delta_surv_i*delta_ti)
delta_surv
n*sum(delta_surv*delta_t)-(n-1)*sum(delta_surv_i*delta_ti)
data$censored_T[1]
n*sum(delta_surv*delta_t)-(n-1)*sum(delta_surv_i*delta_ti)
n*sum(delta_surv*delta_t)-(n-1)*sum(delta_surv_i*delta_ti)
n*sum(delta_surv*delta_t)-(n-1)*sum(delta_surv_i*delta_ti)
n*sum(delta_surv*delta_t)-(n-1)*sum(delta_surv_i*delta_ti)
n*sum(delta_surv*delta_t)-(n-1)*sum(delta_surv_i*delta_ti)
n*sum(delta_surv*delta_t)-(n-1)*sum(delta_surv_i*delta_ti)
n*sum(delta_surv*delta_t)-(n-1)*sum(delta_surv_i*delta_ti)
n*sum(delta_surv*delta_t)-(n-1)*sum(delta_surv_i*delta_ti)
n*sum(delta_surv*delta_t)-(n-1)*sum(delta_surv_i*delta_ti)
delta_surv
delta_surv>delta_surv_i
(delta_surv>delta_surv_i)%>%table()
